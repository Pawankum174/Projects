CREATE TABLE ledger_entries ( id BIGSERIAL PRIMARY KEY, txn_id UUID NOT NULL, account_id UUID NOT NULL REFERENCES accounts(id), entry_type VARCHAR(8) NOT NULL CHECK (entry_type IN ('DEBIT','CREDIT')), amount NUMERIC(18,2) NOT NULL CHECK (amount > 0), currency CHAR(3) NOT NULL, description VARCHAR(256), created_at TIMESTAMPTZ NOT NULL DEFAULT NOW() ); CREATE OR REPLACE FUNCTION prevent_mutation() RETURNS trigger AS $$ BEGIN RAISE EXCEPTION 'Ledger entries are immutable'; END $$ LANGUAGE plpgsql; CREATE TRIGGER ledger_no_update BEFORE UPDATE ON ledger_entries FOR EACH ROW EXECUTE FUNCTION prevent_mutation(); CREATE TRIGGER ledger_no_delete BEFORE DELETE ON ledger_entries FOR EACH ROW EXECUTE FUNCTION prevent_mutation();